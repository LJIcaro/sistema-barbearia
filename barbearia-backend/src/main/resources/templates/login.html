<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Sistema Barbearia</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}">
</head>
<body class="body-center">
<div class="card">
    <h1>游 Sistema Barbearia</h1>

    <!-- Formul치rio de Login -->
    <div id="loginSection">
        <h2>Login</h2>
        <form id="loginForm">
            <div class="form-group">
                <label for="cpfLogin">CPF</label>
                <input id="cpfLogin" type="text" placeholder="000.000.000-00" maxlength="14" required/>
            </div>

            <div class="form-group">
                <label for="senhaLogin">Senha</label>
                <input id="senhaLogin" type="password" placeholder="Digite sua senha" required/>
            </div>

            <button type="submit" class="btn-primary" style="width: 100%;">Entrar</button>
        </form>

        <p id="loginError" class="error-msg" style="display:none;"></p>

        <hr>

        <p class="text-center">
            N칚o tem conta? <a href="#" id="mostrarCadastro" style="color: #667eea; font-weight: 600;">Cadastre-se</a>
        </p>
    </div>

    <!-- Formul치rio de Cadastro -->
    <div id="cadastroSection" class="hidden">
        <h2>Criar Conta</h2>
        <form id="cadastroForm">
            <div class="form-group">
                <label for="nomeCompleto">Nome Completo</label>
                <input id="nomeCompleto" type="text" placeholder="Seu nome completo" required/>
            </div>

            <div class="form-group">
                <label for="cpfCadastro">CPF</label>
                <input id="cpfCadastro" type="text" placeholder="000.000.000-00" maxlength="14" required/>
            </div>

            <div class="form-group">
                <label for="senhaCadastro">Senha</label>
                <input id="senhaCadastro" type="password" placeholder="M칤nimo 8 caracteres" required/>
            </div>

            <div class="form-group">
                <label for="tipoUsuario">Tipo de Usu치rio</label>
                <select id="tipoUsuario" required>
                    <option value="">Selecione...</option>
                    <option value="CLIENTE">Cliente</option>
                    <option value="BARBEIRO">Barbeiro</option>
                </select>
            </div>

            <button type="submit" class="btn-secondary" style="width: 100%;">Criar Conta</button>
        </form>

        <p id="cadastroMsg" class="info-msg" style="display:none;"></p>

        <hr>

        <p class="text-center">
            J치 tem conta? <a href="#" id="mostrarLogin" style="color: #667eea; font-weight: 600;">Fazer login</a>
        </p>
    </div>
</div>

<script src="/barbearia-backend/src/main/resources/static/js/main.js"></script>
<script src="/js/login.js"></script>
<script>
    // Alternar entre login e cadastro
    document.getElementById("mostrarCadastro").addEventListener("click", (e) => {
        e.preventDefault();
        document.getElementById("loginSection").classList.add("hidden");
        document.getElementById("cadastroSection").classList.remove("hidden");
    });

    document.getElementById("mostrarLogin").addEventListener("click", (e) => {
        e.preventDefault();
        document.getElementById("cadastroSection").classList.add("hidden");
        document.getElementById("loginSection").classList.remove("hidden");
    });

    // Formata칞칚o autom치tica de CPF
    function formatarCPFInput(input) {
        let valor = input.value.replace(/\D/g, '');
        if (valor.length <= 11) {
            valor = valor.replace(/(\d{3})(\d)/, '$1.$2');
            valor = valor.replace(/(\d{3})(\d)/, '$1.$2');
            valor = valor.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
        }
        input.value = valor;
    }

    document.getElementById("cpfLogin").addEventListener("input", function() {
        formatarCPFInput(this);
    });

    document.getElementById("cpfCadastro").addEventListener("input", function() {
        formatarCPFInput(this);
    });

    // Login
    document.getElementById("loginForm").addEventListener("submit", async (e) => {
        e.preventDefault();

        const senha = document.getElementById("senhaLogin").value;
        const errorEl = document.getElementById("loginError");
        
        errorEl.style.display = "none";

        // Validar CPF
        if (!validarCPF(cpf)) {
            mostrarErro("loginError", "CPF inv치lido!");
            return;
        }

        try {
            const resp = await fetch("/api/auth/login", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ cpf: cpf, senha: senha })
            });

            if (!resp.ok) {
                const msg = await resp.text();
                mostrarErro("loginError", msg || "CPF ou senha incorretos.");
                return;
            }

            const data = await resp.json();
            
            // Salvar token e dados do usu치rio
            setToken(data.token);
            setUserData(data);

            // Redirecionar baseado no tipo de usu치rio
            if (data.tipoUsuario === "BARBEIRO") {
                window.location.href = "/dashboard";
            } else {
                window.location.href = "/agendamentos";
            }
        } catch (err) {
            console.error(err);
            mostrarErro("loginError", "Erro ao conectar ao servidor.");
        }
    });

    // Cadastro
    document.getElementById("cadastroForm").addEventListener("submit", async (e) => {
        e.preventDefault();

        const nomeCompleto = document.getElementById("nomeCompleto").value;
        const senha = document.getElementById("senhaCadastro").value;
        const tipoUsuario = document.getElementById("tipoUsuario").value;
        const msgEl = document.getElementById("cadastroMsg");

        msgEl.style.display = "none";

        // Valida칞칫es
        if (!validarCPF(cpf)) {
            mostrarErro("cadastroMsg", "CPF inv치lido!");
            return;
        }

        if (senha.length < 8) {
            mostrarErro("cadastroMsg", "A senha deve ter no m칤nimo 8 caracteres.");
            return;
        }

        if (!tipoUsuario) {
            mostrarErro("cadastroMsg", "Selecione o tipo de usu치rio.");
            return;
        }

        try {
            const resp = await fetch("/api/auth/cadastro", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    nomeCompleto: nomeCompleto,
                    cpf: cpf,
                    senha: senha,
                    tipoUsuario: tipoUsuario
                })
            });

            if (!resp.ok) {
                const txt = await resp.text();
                mostrarErro("cadastroMsg", txt || "Erro ao cadastrar.");
                return;
            }

            const data = await resp.json();
            
            // Salvar token e dados do usu치rio
            setToken(data.token);
            setUserData(data);

            mostrarSucesso("cadastroMsg", "Cadastro realizado com sucesso! Redirecionando...");

            // Redirecionar ap칩s 1 segundo
            setTimeout(() => {
                if (data.tipoUsuario === "BARBEIRO") {
                    window.location.href = "/dashboard";
                } else {
                    window.location.href = "/agendamentos";
                }
            }, 1000);
        } catch (err) {
            console.error(err);
            mostrarErro("cadastroMsg", "Erro ao conectar ao servidor.");
        }
    });
</script>
</body>
</html>